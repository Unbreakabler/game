{"version":3,"file":"tower_bullet.js","sources":["../../../../../src/scenes/entities/tower_bullet.ts"],"sourcesContent":["import type { SlotProjectileModifier } from \"../../gamelogic/td/stats_tower_modifiers\";\nimport type TD from \"../td\";\nimport type Enemy from \"./enemies/enemy\";\n\nexport default class Bullet extends Phaser.GameObjects.Image {\n  public dx: number = 0;\n  public dy: number = 0;\n  public lifespan: number = 1000;\n  public speed: number = 400;\n  public damage: number = 0;\n  public range: number = 600;\n  public tower_id!: string;\n\n  private td_scene: TD;\n  private mods!: SlotProjectileModifier[];\n  private chains: number = 0;\n  private last_enemy_hit!: Enemy;\n  private original_lifespan: number = 1000;\n\n  public constructor(scene: Phaser.Scene) {\n    super(scene, 0, 0, \"small_bullet\");\n    this.td_scene = scene as TD;\n    scene.add.existing(this);\n    scene.physics.add.existing(this);\n    this.body.setSize(25, 25); // set physics body collision size\n    this.setActive(false);\n    this.setVisible(false);\n  }\n\n\n  public fire(tower_id: string, x: number, y: number, angle: number, range: number, damage: number, projectile_modifiers: SlotProjectileModifier[]): void {\n    this.tower_id = tower_id;\n    this.setActive(true);\n    this.setVisible(true);\n    if (!this.mods) this.initialize_mods(projectile_modifiers)\n    this.setPosition(x, y);\n    this.setRotation(angle - Math.PI / 2); // FIXME(jon): not necessary if proj is round\n    const dx = Math.cos(angle);\n    const dy = Math.sin(angle);\n    this.body.setVelocity(dx * this.speed, dy * this.speed)\n    this.damage = damage;\n    this.range = range;\n  }\n\n  public update(time: number, delta: number): void {\n    this.lifespan -= delta;\n    if (this.lifespan <= 0) {\n      console.log('BULLET LIFESPAN EXPIRED')\n      this.setActive(false);\n      this.setVisible(false);\n      this.destroy();\n    }\n  }\n/**\n * Returns damage done by hit.\n * \n * Retargets and refires projectile for certain modifiers (chain).\n */\n  public hit(enemy: Enemy): number | null {\n    if (enemy === this.last_enemy_hit) return null;\n\n    let still_alive = false;\n    if (this.chains > 0) {\n      this.lifespan = this.original_lifespan;\n      const e = this.findClosestEnemyInRange(this.range, enemy);\n      if (e) {\n        this.last_enemy_hit = enemy;\n        still_alive = true\n        this.chains--;\n        const angle = Phaser.Math.Angle.Between(this.x, this.y, e.x, e.y)\n        const dx = Math.cos(angle);\n        const dy = Math.sin(angle);\n        this.body.setVelocity(dx * this.speed, dy * this.speed);\n      } else {\n        console.log('NO ENEMY IN CHAIN RANGE')\n        this.chains = 0;\n        this.lifespan = 0;\n      }\n    } \n    if (!still_alive) this.destroy();\n    return this.damage;\n  }\n\n  private initialize_mods(projectile_modifiers: SlotProjectileModifier[] = []) {\n    this.mods = projectile_modifiers;\n    this.mods.forEach(mod => {\n      if (mod.chains) this.chains += mod.chains\n    })\n  }\n\n  private findClosestEnemyInRange(range: number = 0, current_target: Enemy): Enemy | undefined {\n    const enemies = this.td_scene.wave_manager.enemies;\n    let closest_enemy: Enemy | undefined;\n    let closest_distance = Number.MAX_VALUE;\n    for (const e of enemies.getChildren()) {\n      if (e === current_target || e === this.last_enemy_hit) continue;\n      const d = Phaser.Math.Distance.Squared(this.x, this.y, e.x, e.y);\n      if (d < range*range && d < closest_distance) {\n        closest_distance = d;\n        closest_enemy = e;\n      }\n    }\n    return closest_enemy;\n  }\n}\n"],"names":[],"mappings":"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"}