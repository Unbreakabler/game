{"version":3,"file":"turret.js","sources":["../../../../../../src/scenes/entities/towers/turret.ts"],"sourcesContent":["const DEFAULT_RANGE = 200;\nconst DEFAULT_ATTACK_SPEED = 1000;\nconst DEFAULT_DAMAGE = 50;\n\nconst PLACEABLE_MIN_DISTANCE_FROM_PATH = 50;\n\nimport Bullet from '../tower_bullet'\n\nexport default class Turret extends Phaser.GameObjects.Image {\n  private next_tick = 0;\n  private projectiles: Phaser.GameObjects.Group;\n  private range = DEFAULT_RANGE;\n  private attack_speed = DEFAULT_ATTACK_SPEED;\n  private damage = DEFAULT_DAMAGE;\n\n  constructor(scene: Phaser.Scene, x: number = 0, y:number = 0, \n              sprite_name: string = 'turret', range: number = DEFAULT_RANGE, \n              attack_speed: number = DEFAULT_ATTACK_SPEED, damage: number = DEFAULT_DAMAGE) {\n    super(scene, 0, 0, sprite_name);\n    this.range = range;\n    this.attack_speed = attack_speed;\n    this.damage = damage;\n    this.projectiles = this.scene.physics.add.group({ classType: Bullet, runChildUpdate: true });\n  }\n\n  private isPlaceable(place_x: number, place_y: number, width: number, height: number, turrets: Phaser.GameObjects.Group, path: Phaser.Curves.Path): boolean {\n    const min_dist = path.getPoints(path.getLength()/20).reduce((acc, point) => {\n      return Math.min(Phaser.Math.Distance.Between(place_x, place_y, point.x, point.y), acc);\n    }, 1000)\n    if (min_dist < PLACEABLE_MIN_DISTANCE_FROM_PATH) {\n      return false // Can not place turret next to path\n    }\n\n    for (const t of turrets.children.entries) {\n      let min_x = t.x - t.width/2\n      let max_x = t.x + t.width/2\n      let min_y = t.y - t.height/2\n      let max_y = t.y + t.height/2\n  \n      let new_min_x = place_x - width/2\n      let new_max_x = place_x + width/2\n      let new_min_y = place_y - height/2\n      let new_max_y = place_y + height/2\n  \n      const x_overlap = Math.max(0, Math.min(max_x, new_max_x) - Math.max(min_x, new_min_x));\n      const y_overlap = Math.max(0, Math.min(max_y, new_max_y) - Math.max(min_y, new_min_y));\n  \n      if (x_overlap * y_overlap > 0) {\n        return false // Can not place a turret overlapping another turret\n      }\n    }\n    return true\n  }\n\n  public place (place_x: number, place_y: number, width: number, height: number, turrets: Phaser.GameObjects.Group, path: Phaser.Curves.Path) {\n    if (this.isPlaceable(place_x, place_y, width, height, turrets, path)) {\n      this.x = place_x;\n      this.y = place_y;\n      this.setActive(true);\n      this.setVisible(true);\n      this.setInteractive();\n    } else {\n      console.error(`Error placing turret @ x:${place_x}, y:${place_y}`)\n      this.setActive(false);\n      this.setVisible(false);\n    }\n  }\n\n  public update (time: number, delta: number) {\n    // time to shoot\n    if (time > this.next_tick) {    \n      this.fire();\n      this.next_tick = time + this.attack_speed;\n    }\n  }\n\n  public fire() {\n    const enemy = this.scene.getEnemy(this.x, this.y, this.range - 50);\n    if (enemy) {\n        const angle = Phaser.Math.Angle.Between(this.x, this.y, enemy.x, enemy.y);\n        this.addBullet(this.x, this.y, angle);\n        this.angle = (angle + Math.PI/2) * Phaser.Math.RAD_TO_DEG;\n    }\n  }\n\n  public addBullet(x: number, y: number, angle: number) {\n    if (this.projectiles) {\n      const bullet = this.projectiles.get();\n      if (bullet) {\n          bullet.fire(x, y, angle, this.range, this.damage);\n      }\n    }\n  }\n\n  public enableBulletCollisions(enemies: Phaser.GameObjects.Group) {\n    this.scene.physics.add.overlap(enemies, this.projectiles, this.scene.damageEnemy)\n  }\n}"],"names":[],"mappings":"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"}