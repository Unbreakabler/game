{"version":3,"file":"turret.js","sources":["../../../../../../src/scenes/entities/towers/turret.ts"],"sourcesContent":["import type TD from \"../../td\";\nimport Bullet from \"../tower_bullet\";\nimport type Enemy from \"../enemies/enemy\";\nimport { gameModel, GameModel } from \"../../../gamelogic/gamemodel\";\nimport type { TowerId, TowerInfo, TargetingMode } from \"../../../gamelogic/td/tower_defense\";\n\nconst DEFAULT_RANGE = 200;\nconst DEFAULT_ATTACK_SPEED = 1000;\nconst DEFAULT_DAMAGE = 50;\nconst PLACEABLE_MIN_DISTANCE_FROM_PATH = 25;\n\n\nexport default class Turret extends Phaser.GameObjects.Image {\n  public range = DEFAULT_RANGE;\n  public attack_speed = DEFAULT_ATTACK_SPEED;\n  public damage = DEFAULT_DAMAGE;\n  public is_selected = false;\n  public show_range = false;\n  public is_placed = false;\n  public tower_id: string;\n  \n  private projectiles: BetterGroup<Bullet>;\n  public display_range:  Phaser.GameObjects.Arc;\n  private td_scene: TD;\n  private next_tick = 0;\n  private tower_info!: TowerInfo | null;\n  private target!: Enemy | null;\n  private target_indicator!: Phaser.GameObjects.Arc;\n  private targeting_mode: TargetingMode = 'closest'\n\n  public constructor(\n    td_scene: TD,\n    tower_id: string,\n    x: number = 0,\n    y: number = 0,\n    sprite_name: string = \"turret\",\n  ) {\n    super(td_scene, x, y, sprite_name);\n    this.td_scene = td_scene;\n    this.tower_id = tower_id;\n    // TODO(jon): Projectiles will have to be managed different to allow differently projectiles for each turret.\n    this.projectiles = this.td_scene.add.group({ classType: Bullet, active: true, runChildUpdate: true }) as BetterGroup<Bullet>;\n    this.display_range = this.td_scene.add.circle(0, 0, this.range, 0xff0000, 0.5);\n    this.display_range.setVisible(false);\n    this.setupTowerSubscription(tower_id)\n  }\n\n  private setupTowerSubscription(tower_id: string) {\n    const unsubscribe_store = gameModel.subscribe((model) => {\n      this.tower_info = model.tower_defense.getTower(tower_id as TowerId)\n  \n      if (this.tower_info) {\n        if (this.range !== this.tower_info.attributes.range) {\n          this.range = this.tower_info.attributes.range\n          this.display_range.setRadius(this.range)\n        }\n        if (this.attack_speed !== this.tower_info.attributes.attack_speed) {\n          this.attack_speed = this.tower_info.attributes.attack_speed\n        }\n        if (this.damage !== this.tower_info.attributes.damage) {\n          this.damage = this.tower_info.attributes.damage\n        }\n        if (this.is_selected !== this.tower_info.status.is_selected) {\n          this.is_selected = this.tower_info.status.is_selected\n        }\n        if (this.is_placed !== this.tower_info.status.is_placed) {\n          this.is_placed = this.tower_info.status.is_placed;\n        }\n        if (this.targeting_mode !== this.tower_info.status.targeting_mode) {\n          this.targeting_mode = this.tower_info.status.targeting_mode;\n        }\n      }\n    })\n    this.td_scene.events.on(\"destroy\", function () {\n      unsubscribe_store();\n    });\n  }\n\n  public preUpdate() { this.displayRange() }\n\n  public update(time: number, delta: number): void {\n    if (!this.is_placed) return;\n\n    //Look at near enemies\n    // let targetingFunction = (x: number) => this.findClosestEnemyInRange(x);\n    // if (this.targeting_mode === 'last') targetingFunction = (x: number) => this.findLastEnemyInRange(x);\n    // if (this.targeting_mode === 'first') targetingFunction = (x: number) => this.findFirstEnemyInRange(x);\n    // if (this.targeting_mode === 'strongest') targetingFunction = (x: number) => this.findStrongestEnemyInRange(x);\n\n    let e;\n    if (this.targeting_mode === 'closest') e = this.findClosestEnemyInRange(20);\n    if (this.targeting_mode === 'last') e = this.findLastEnemyInRange(20);\n    if (this.targeting_mode === 'first') e = this.findFirstEnemyInRange(20);\n    if (this.targeting_mode === 'strongest') e = this.findStrongestEnemyInRange(20);\n\n    if (e) {\n      this.targetEnemy(e);\n    } else if (this.target_indicator) {\n      this.target_indicator.setVisible(false);\n    }\n    // time to shoot\n    if (time > this.next_tick) {\n      //If fired at enemy, start cooldown\n      if (this.attemptToFire()) this.next_tick = time + this.attack_speed;\n    }\n  }\n\n  public preDestroy() {\n    if (this.tower_info) {\n      this.tower_info.status.is_selected = false;\n      this.tower_info.status.is_placed = false;\n    }\n    this.displayRange();\n  }\n\n  private isPlaceable(\n    place_x: number,\n    place_y: number,\n  ): boolean {\n    // TODO(jon): check performance here\n    const min_dist = this.td_scene.path.getPoints(this.td_scene.path.getLength() / 20).reduce((acc, point) => {\n      return Math.min(Phaser.Math.Distance.Between(place_x, place_y, point.x, point.y), acc);\n    }, 1000);\n    if (min_dist < PLACEABLE_MIN_DISTANCE_FROM_PATH) {\n      // console.error('Can not place turret next to path')\n      return false;\n    }\n\n    for (const t of this.td_scene.tower_map.values()) {\n      if (t == this.td_scene.selected_turret) continue; // current turret on cursor\n\n      const min_x = t.x - t.width/2\n      const max_x = t.x + t.width/2\n      const min_y = t.y - t.height/2\n      const max_y = t.y + t.height/2\n  \n      const new_min_x = place_x - this.width/2\n      const new_max_x = place_x + this.width/2\n      const new_min_y = place_y - this.height/2\n      const new_max_y = place_y + this.height/2\n  \n      const x_overlap = Math.max(0, Math.min(max_x, new_max_x) - Math.max(min_x, new_min_x));\n      const y_overlap = Math.max(0, Math.min(max_y, new_max_y) - Math.max(min_y, new_min_y));\n\n      if (x_overlap * y_overlap > 0) {\n        // console.error('Can not place a turret overlapping another turret')\n        return false;\n      }\n    }\n    return true;\n  }\n\n  public place(place_x: number, place_y: number): boolean {\n    if (!this.isPlaceable(place_x, place_y)) {\n      console.error(`Error placing turret @ x:${place_x}, y:${place_y}`);\n      return false;\n    }\n    this.x = place_x;\n    this.y = place_y;\n    this.setActive(true);\n    this.setVisible(true);\n    this.setInteractive();\n    console.log(`placing turret @ x:${place_x}, y:${place_y}`);\n    this.is_placed = true;\n    this.select(false);\n    this.enableBulletCollisions();\n    return true;\n  }\n\n  public displayRange() {\n    const red = 0xff0000\n    const green = 0x00ff00\n    const blue = 0x0000ff\n    this.display_range.x = this.x;\n    this.display_range.y = this.y;\n    if (this.is_selected) {\n      this.display_range.setVisible(true);\n      this.display_range.setStrokeStyle(2, 0xffffff);\n      if (!this.is_placed) {\n        if (this.isPlaceable(this.x, this.y)) {\n          this.display_range.setFillStyle(green, 0.3);\n        } else {\n          this.display_range.setFillStyle(red, 0.3);\n        }\n      } else {\n        this.display_range.setFillStyle(blue, 0.15);\n      }\n    } else {\n      this.display_range.setVisible(false);\n    }\n  }\n\n  public attemptToFire(): boolean {\n    //Enemy Found\n    let e;\n    if (this.targeting_mode === 'closest') e = this.findClosestEnemyInRange(20);\n    if (this.targeting_mode === 'last') e = this.findLastEnemyInRange(20);\n    if (this.targeting_mode === 'first') e = this.findFirstEnemyInRange(20);\n    if (this.targeting_mode === 'strongest') e = this.findStrongestEnemyInRange(20);\n\n    if (e) {\n      //Add bullet\n      this.fireBullet(this.x, this.y, this.getAngleToEnemy(e));\n      //Update where turret is pointing\n      this.targetEnemy(e);\n      return true;\n    }\n    return false;\n  }\n\n  private findClosestEnemyInRange(range_bonus: number = 0): Enemy | undefined {\n    const enemies = this.td_scene.wave_manager.enemies;\n    let closest_enemy: Enemy | undefined;\n    let closest_distance = Number.MAX_VALUE;\n    for (const e of enemies.getChildren()) {\n      const d = Phaser.Math.Distance.Between(this.x, this.y, e.x, e.y);\n      if (d < this.range + range_bonus) {\n        if (d < closest_distance) {\n          closest_distance = d;\n          closest_enemy = e;\n        }\n      }\n    }\n    return closest_enemy;\n  }\n\n  private findFirstEnemyInRange(range_bonus: number = 0): Enemy | undefined {\n    const enemies = this.td_scene.wave_manager.enemies;\n    let first_enemy: Enemy | undefined;\n    let first_distance = Number.MIN_VALUE;\n    for (const e of enemies.getChildren()) {\n      const d = Phaser.Math.Distance.Between(this.x, this.y, e.x, e.y);\n      if (d < this.range + range_bonus) {\n        if (e.follower.t > first_distance) {\n          first_distance = e.follower.t;\n          first_enemy = e;\n        }\n      }\n    }\n    return first_enemy;\n  }\n\n  private findLastEnemyInRange(range_bonus: number = 0): Enemy | undefined {\n    const enemies = this.td_scene.wave_manager.enemies;\n    let furthest_enemy: Enemy | undefined;\n    let furthest_distance = Number.MAX_VALUE;\n    for (const e of enemies.getChildren()) {\n      const d = Phaser.Math.Distance.Between(this.x, this.y, e.x, e.y);\n      if (d < this.range + range_bonus) {\n        if (e.follower.t < furthest_distance) {\n          furthest_distance = e.follower.t;\n          furthest_enemy = e;\n        }\n      }\n    }\n    return furthest_enemy;\n  }\n\n  private findStrongestEnemyInRange(range_bonus: number = 0): Enemy | undefined {\n    const enemies = this.td_scene.wave_manager.enemies;\n    let furthest_enemy: Enemy | undefined;\n    let height_hp = Number.MIN_VALUE;\n    for (const e of enemies.getChildren()) {\n      const d = Phaser.Math.Distance.Between(this.x, this.y, e.x, e.y);\n      if (d < this.range + range_bonus) {\n        if (e.health_points > height_hp) {\n          height_hp = e.follower.t;\n          furthest_enemy = e;\n        }\n      }\n    }\n    return furthest_enemy;\n  }\n\n  // firing modes:\n  // first, last, strongest, closest\n\n  private getAngleToEnemy(enemy: Enemy): number {\n    return Phaser.Math.Angle.Between(this.x, this.y, enemy.x, enemy.y);\n  }\n\n  private targetEnemy(enemy: Enemy): void {\n    if (!this.target_indicator) {\n      this.target_indicator = this.td_scene.add.circle(enemy.x, enemy.y, enemy.width, 0xff0000)\n    }\n    if (!this.tower_info?.status.is_selected) {\n      this.target_indicator.setVisible(false);\n      // return;\n    }\n    if (this.target != enemy && this.tower_info?.status.is_selected) {\n      // this.target = enemy\n      this.target_indicator.width = enemy.width;\n      this.target_indicator.setVisible(true);\n      this.target_indicator.setStrokeStyle(2, 0xffffff)\n      this.target_indicator.setAlpha(0.4)\n    }\n    this.target_indicator.setPosition(enemy.x, enemy.y)\n    this.rotation = this.getAngleToEnemy(enemy) + Math.PI / 2;\n  }\n\n  public fireBullet(x: number, y: number, angle: number): void {\n    const b = this.projectiles.get();\n    //TODO - Make bullets smart so they follow units\n    const dx = Math.cos(angle);\n    const dy = Math.sin(angle);\n    // position the bullet in front of the tower \"cannon\". If the tower is not a cannon this will cause the projectile to\n    // spawn in front of the turret. Another approach here is to have all projectiles spawn at the turret center, but render\n    // under the tower sprite.\n    b.fire(this.tower_id, x + (dx * (this.width - 10)), y + (dy * (this.height - 10)), angle, this.range, this.damage);\n  }\n\n  public enableBulletCollisions(): void {\n    this.scene.physics.add.overlap(this.td_scene.wave_manager.enemies, this.projectiles, this.td_scene.damageEnemy as ArcadePhysicsCallback);\n  }\n\n  public select(is_selected = true): void {\n    if (this.tower_info) {\n      this.tower_info.status.is_selected = is_selected;\n    }\n  }\n}"],"names":[],"mappings":"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"}