{"version":3,"file":"tower.js","sources":["../../../../../../src/scenes/entities/towers/tower.ts"],"sourcesContent":["/**\n * Second attempt a writing a tower class. The goal of the rewrite is to add a component system to towers that can used for extension.\n * I also want an easier way to manage multiple sprites related to a single tower, and manage post processing effects on any set of those sprites.\n */\n\nimport type { TargetingMode, TowerId, TowerInfo } from \"../../../gamelogic/td/tower_defense\";\nimport type TD from \"../../td\";\nimport rotating_turret from \"./components/tower_rotating_turret\";\nimport tower_base from \"./components/tower_base\";\nimport type { TowerComponent } from \"./components/component_interface\";\nimport type Enemy from \"../enemies/enemy\";\nimport target_handler from \"./components/target_handler\";\nimport target_indicator from \"./components/target_indicator\";\nimport range_indicator from \"./components/range_indicator\";\nimport projectile_handler from \"./components/projectile_handler\";\nimport placement_handler from \"./placement_handler\";\nimport selection_handler from \"./components/selection_handler\";\n\ntype TowerSelection = 'selected' | 'hovered' | undefined;\n\nexport default class Tower extends Phaser.GameObjects.GameObject {\n  public tower_id: TowerId;\n  public tower_info: TowerInfo;\n  public td_scene: TD;\n\n  public is_placed: boolean = false;\n  public is_placeable: boolean = true;\n  \n  public x: number;\n  public y: number;\n\n  public range: number;\n  public range_indicator?: Phaser.GameObjects.Arc;\n  \n  public width?: number;\n  public height?: number;\n\n  public rotating_sprites?: Phaser.GameObjects.Container;\n  public static_sprites?: Phaser.GameObjects.Container;\n  public selection: TowerSelection;\n  private components: TowerComponent[];\n\n  public targeting_mode: TargetingMode = 'first'\n  public target?: Enemy;\n  public target_angle: number = 0;\n  public targeting_indicator?: Phaser.GameObjects.Arc;\n  private targeting_components: TowerComponent[];\n\n  public projectiles?: BetterGroup<any>;\n\n  public attack_speed: number = 100;\n\n  public time_elapsed: number = 0;\n  public time_to_fire_next_shot: number = 0;\n  private projectile_components: TowerComponent[];\n  private placement_components: TowerComponent[];\n\n  public constructor(\n    td_scene: TD,\n    tower: TowerInfo,\n    components = (tower: TowerInfo) => ([ tower_base(), rotating_turret(tower.status.type) ]),\n    targeting_components = (tower: TowerInfo) => ([target_handler(tower), target_indicator()]),\n    projectile_components = (tower: TowerInfo) => ([projectile_handler(tower)]),\n    placement_components = (tower: TowerInfo) => ([placement_handler(), range_indicator(), selection_handler()]),\n    range: number = 300,\n  ) {\n    super(td_scene, 'tower');\n    td_scene.add.existing(this)\n    this.td_scene = td_scene;\n    this.x = tower.status.x;\n    this.y = tower.status.y;\n    this.range = range;\n\n    \n    // use tower_id to fetch attributes\n    // calculate attributes with modifiers\n    this.tower_id = tower.status.id;\n    this.tower_info = tower;\n    \n    // fetch linked components? For now components are hardcoded in td.ts\n    this.components = components(this.tower_info);\n    this.targeting_components = targeting_components(this.tower_info);\n    this.projectile_components = projectile_components(this.tower_info);\n    this.placement_components = placement_components(this.tower_info);\n\n    // call component initializers\n    this.components.forEach(c => {\n      if (c.onInit) c.onInit(this, td_scene, this.x, this.y)\n    })\n\n    this.targeting_components.forEach(c => {\n      if (c.onInit) c.onInit(this, td_scene, this.x, this.y)\n    })\n\n    this.projectile_components.forEach(c => {\n      if (c.onInit) c.onInit(this, td_scene, this.x, this.y)\n    })\n\n    this.placement_components.forEach(c => {\n      if (c.onInit) c.onInit(this, td_scene, this.x, this.y)\n    })\n\n    this.setVisible(false);\n    this.targeting_indicator?.setVisible(false);\n    this.selection = undefined;\n  }\n\n  public place(x: number, y: number) {\n    this.x = x; \n    this.y = y;\n    this.is_placed = true;\n    this.is_placeable = false;\n    this.setActive(true);\n    this.setVisible(true);\n  }\n\n  public setVisible(flag: boolean = true) { \n    this.rotating_sprites?.setVisible(flag);\n    this.static_sprites?.setVisible(flag); \n    this.range_indicator?.setVisible(flag);\n  }\n\n  public setPosition(x: number, y: number) {\n    this.rotating_sprites?.setPosition(x, y);\n    this.static_sprites?.setPosition(x, y);\n    this.range_indicator?.setPosition(x, y);\n  }\n\n  public update(time: number, delta: number) {\n    this.placement_components.forEach(c => {\n      if (typeof c?.onUpdate == 'function') c.onUpdate(this, time, delta)\n    })\n\n    if (!this.is_placed) return;\n\n    this.components.forEach(c => {\n      if (typeof c?.onUpdate == 'function') c.onUpdate(this, time, delta)\n    })\n\n    this.targeting_components.forEach(c => {\n      if (typeof c?.onUpdate == 'function') c.onUpdate(this, time, delta)\n    })\n\n    this.projectile_components.forEach(c => {\n      if (typeof c?.onUpdate == 'function') c.onUpdate(this, time, delta)\n    })\n\n  }\n}"],"names":[],"mappings":"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"}