{"version":3,"file":"gamemodel.js","sources":["../../../../src/gamelogic/gamemodel.ts"],"sourcesContent":["import { deserialize, Exclude, serialize, Transform, Type } from \"class-transformer\";\nimport { writable } from \"svelte/store\";\nimport type { IIndexable } from \"./td/stats_tower_modifiers\";\nimport { TowerDefense } from \"./td/tower_defense\";\nimport type { Achievable, ValidAchievableShortName } from \"./village/achievable\";\nimport { FarmJob } from \"./village/farmjob\";\nimport { farmJobTransformer, get_default_farm_jobs } from \"./village/farmjobs\";\nimport { Mine } from \"./village/mine\";\nimport { get_default_mines, MINE, MineTransformer } from \"./village/mines\";\nimport { VillageBuilding } from \"./village/villagebuilding\";\nimport { get_default_village_buildings, villageBuildingTransformer } from \"./village/villagebuildings\";\n\nexport class Wallet {\n  public money: number = 10_000;\n  public constructor() {\n    this.money = 10_000;\n  }\n}\n\nexport class Resources {\n  public dirt: integer = 0;\n  public stone: integer = 0;\n}\n\n/**\n * This class holds the data the game needs to function.\n * It will be accessible from anywhere in the game using svelte stores.\n */\nexport class GameModel {\n  public last_saved: number;\n\n  @Type(() => Wallet)\n  public wallet: Wallet;\n\n  @Type(() => Resources)\n  public resources: Resources;\n\n  @Type(() => FarmJob)\n  @Transform(farmJobTransformer, { toClassOnly: true })\n  public farm_jobs: Map<string, FarmJob> = new Map();\n\n  @Type(() => VillageBuilding)\n  @Transform(villageBuildingTransformer, { toClassOnly: true })\n  public village_buildings: Map<string, VillageBuilding> = new Map();\n\n  @Type(() => Mine)\n  @Transform(MineTransformer, { toClassOnly: true })\n  public mines: Map<string, Mine> = new Map();\n\n  @Exclude()\n  public achievables: Map<string, Achievable> = new Map();\n  \n  @Type(() => TowerDefense)\n  public tower_defense: TowerDefense;\n\n  public constructor() {\n    //Create new empty GameModel\n    this.last_saved = Date.now();\n    this.wallet = new Wallet();\n    this.resources = new Resources();\n    this.farm_jobs = get_default_farm_jobs();\n    this.village_buildings = get_default_village_buildings();\n    this.mines = get_default_mines();\n    this.tower_defense = new TowerDefense();\n    this.reloadAchievables();\n  }\n\n  public reloadAchievables(): void {\n    this.achievables = new Map([...this.farm_jobs as Map<string, Achievable>, ...this.mines as Map<string, Achievable>]);\n  }\n\n  public update(delta_t_s: number): void {\n    const delta_t_ms = delta_t_s * 1000\n    for (const [key, farm_job] of this.farm_jobs.entries()) {\n      farm_job.update(delta_t_s);\n      farm_job.earnIncome(this.wallet, delta_t_s);\n    }\n    for (const [key, mine] of this.mines.entries()) {\n      mine.update(this.resources, delta_t_ms);\n    }\n  }\n\n  public exportToSave(): string {\n    this.last_saved = Date.now();\n    console.log('saving', this)\n    return serialize(this);\n  }\n\n  public static loadFromSave(data: string): GameModel {\n    const model = deserialize(GameModel, data);\n    model.reloadAchievables();\n    return model;\n  }\n\n  public setActiveFarmJob(achievable_name: string): void {\n    for (const [key, farm_job] of this.farm_jobs.entries()) {\n      farm_job.active = false;\n    }\n    const job = this.farm_jobs.get(achievable_name);\n    if (!job) throw new Error(`Missing FarmJob ${achievable_name}`);\n    job.active = true;\n  }\n\n  public activateMine(achievable_name: MINE): void {\n    const mine = this.mines.get(achievable_name)\n    if (!mine) throw new Error(`Missing mine ${achievable_name}`)\n    mine.active = true;\n  }\n\n  public levelMine(achievable_name: MINE): void {\n    const mine = this.mines.get(achievable_name)\n    if (!mine) throw new Error(`Missing mine ${achievable_name}`)\n\n    mine.requestLevelUp(this.wallet);\n  }\n}\n\n/**\n * A writable store of the gameModel that can be accessed from other parts of the application.\n */\nexport const gameModel = writable(new GameModel());\n\n/**\n * A function that can be called anywhere to update the game model in the svelte store.\n * This will trigger the svelte components to re-evaluate and update their content.\n */\nexport function updateGameModel(): void {\n  gameModel.update((m) => (m = m));\n}\n"],"names":[],"mappings":"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"}