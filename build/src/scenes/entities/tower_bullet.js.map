{"version":3,"file":"tower_bullet.js","sources":["../../../../../src/scenes/entities/tower_bullet.ts"],"sourcesContent":["import type { GameModel } from \"../../gamelogic/gamemodel\";\nimport type { SlotProjectileModifier } from \"../../gamelogic/td/stats_tower_modifiers\";\nimport type TD from \"../td\";\nimport type Enemy from \"./enemies/enemy\";\n\nexport default class Bullet extends Phaser.GameObjects.Image {\n  public dx: number = 0;\n  public dy: number = 0;\n  public lifespan: number = 0;\n  public speed: number = 0;\n  public damage: number = 0;\n  public range: number = 0;\n  public tower_id!: string;\n\n  private td_scene: TD;\n  private mods!: SlotProjectileModifier[];\n  private chains: number = 0;\n  private last_enemy_hit!: Enemy;\n\n  public constructor(scene: Phaser.Scene) {\n    super(scene, 0, 0, \"small_bullet\");\n    this.td_scene = scene as TD;\n    scene.add.existing(this);\n    scene.physics.add.existing(this);\n    this.dx = 0;\n    this.dy = 0;\n    this.lifespan = 0;\n    this.speed = Phaser.Math.GetSpeed(600, 1);\n  }\n\n  public fire(tower_id: string, x: number, y: number, angle: number, range: number, damage: number, projectile_modifiers: SlotProjectileModifier[]): void {\n    this.tower_id = tower_id;\n    if (!this.mods) this.initialize_mods(projectile_modifiers)\n    this.setActive(true);\n    this.setVisible(true);\n    this.setPosition(x, y);\n    this.setRotation(angle - Phaser.Math.PI2 / 4); // FIXME(jon): not necessary if proj is round\n    this.dx = Math.cos(angle);\n    this.dy = Math.sin(angle);\n    this.lifespan = range * 1.3;\n    this.damage = damage;\n    this.range = range;\n  }\n\n  public update(time: number, delta: number): void {\n    this.lifespan -= delta;\n\n    this.x += this.dx * (this.speed * delta);\n    this.y += this.dy * (this.speed * delta);\n\n    if (this.lifespan <= 0) {\n      this.setActive(false);\n      this.setVisible(false);\n    }\n  }\n\n  // returns damage\n  // This is where a \"chain\" or \"aoe\" caluclation would take place if present on the projectile.\n  public hit(enemy: Enemy): number | null {\n    if (enemy === this.last_enemy_hit) return null;\n\n    let still_alive = false;\n    if (this.chains > 0) {\n      // target new enemy\n      // set chain range\n      // \"fire\" bullet in new direction\n      const e = this.findClosestEnemyInRange(this.range, enemy);\n      if (e) {\n        this.last_enemy_hit = enemy;\n        still_alive = true\n        this.chains--;\n        const angle = Phaser.Math.Angle.Between(this.x, this.y, e.x, e.y)\n        this.fire(this.tower_id, this.x, this.y, angle, this.range, this.damage, this.mods)\n      } else {\n        this.chains = 0;\n      }\n    } \n    if (!still_alive) this.destroy();\n    return this.damage;\n  }\n\n  private initialize_mods(projectile_modifiers: SlotProjectileModifier[] = []) {\n    this.mods = projectile_modifiers;\n    this.mods.forEach(mod => {\n      if (mod.chains) this.chains += mod.chains\n    })\n  }\n\n  private findClosestEnemyInRange(range: number = 0, current_target: Enemy): Enemy | undefined {\n    const enemies = this.td_scene.wave_manager.enemies;\n    let closest_enemy: Enemy | undefined;\n    let closest_distance = Number.MAX_VALUE;\n    for (const e of enemies.getChildren()) {\n      if (e === current_target) continue;\n      if (e === this.last_enemy_hit) {\n        continue;\n      };\n      const d = Phaser.Math.Distance.Squared(this.x, this.y, e.x, e.y);\n      if (d < range*range && d < closest_distance) {\n        closest_distance = d;\n        closest_enemy = e;\n      }\n    }\n    return closest_enemy;\n  }\n}\n"],"names":[],"mappings":"MAKqB,MAAO,SAAQ,MAAM,CAAC,WAAW,CAAC,KAAK;IAc1D,YAAmB,KAAmB;QACpC,KAAK,CAAC,KAAK,EAAE,CAAC,EAAE,CAAC,EAAE,cAAc,CAAC,CAAC;QAd9B,OAAE,GAAW,CAAC,CAAC;QACf,OAAE,GAAW,CAAC,CAAC;QACf,aAAQ,GAAW,CAAC,CAAC;QACrB,UAAK,GAAW,CAAC,CAAC;QAClB,WAAM,GAAW,CAAC,CAAC;QACnB,UAAK,GAAW,CAAC,CAAC;QAKjB,WAAM,GAAW,CAAC,CAAC;QAKzB,IAAI,CAAC,QAAQ,GAAG,KAAW,CAAC;QAC5B,KAAK,CAAC,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;QACzB,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;QACjC,IAAI,CAAC,EAAE,GAAG,CAAC,CAAC;QACZ,IAAI,CAAC,EAAE,GAAG,CAAC,CAAC;QACZ,IAAI,CAAC,QAAQ,GAAG,CAAC,CAAC;QAClB,IAAI,CAAC,KAAK,GAAG,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC;KAC3C;IAEM,IAAI,CAAC,QAAgB,EAAE,CAAS,EAAE,CAAS,EAAE,KAAa,EAAE,KAAa,EAAE,MAAc,EAAE,oBAA8C;QAC9I,IAAI,CAAC,QAAQ,GAAG,QAAQ,CAAC;QACzB,IAAI,CAAC,IAAI,CAAC,IAAI;YAAE,IAAI,CAAC,eAAe,CAAC,oBAAoB,CAAC,CAAA;QAC1D,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;QACrB,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC;QACtB,IAAI,CAAC,WAAW,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;QACvB,IAAI,CAAC,WAAW,CAAC,KAAK,GAAG,MAAM,CAAC,IAAI,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC;QAC9C,IAAI,CAAC,EAAE,GAAG,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;QAC1B,IAAI,CAAC,EAAE,GAAG,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;QAC1B,IAAI,CAAC,QAAQ,GAAG,KAAK,GAAG,GAAG,CAAC;QAC5B,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;QACrB,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;KACpB;IAEM,MAAM,CAAC,IAAY,EAAE,KAAa;QACvC,IAAI,CAAC,QAAQ,IAAI,KAAK,CAAC;QAEvB,IAAI,CAAC,CAAC,IAAI,IAAI,CAAC,EAAE,IAAI,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC,CAAC;QACzC,IAAI,CAAC,CAAC,IAAI,IAAI,CAAC,EAAE,IAAI,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC,CAAC;QAEzC,IAAI,IAAI,CAAC,QAAQ,IAAI,CAAC,EAAE;YACtB,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;YACtB,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,CAAC;SACxB;KACF;;;IAIM,GAAG,CAAC,KAAY;QACrB,IAAI,KAAK,KAAK,IAAI,CAAC,cAAc;YAAE,OAAO,IAAI,CAAC;QAE/C,IAAI,WAAW,GAAG,KAAK,CAAC;QACxB,IAAI,IAAI,CAAC,MAAM,GAAG,CAAC,EAAE;;;;YAInB,MAAM,CAAC,GAAG,IAAI,CAAC,uBAAuB,CAAC,IAAI,CAAC,KAAK,EAAE,KAAK,CAAC,CAAC;YAC1D,IAAI,CAAC,EAAE;gBACL,IAAI,CAAC,cAAc,GAAG,KAAK,CAAC;gBAC5B,WAAW,GAAG,IAAI,CAAA;gBAClB,IAAI,CAAC,MAAM,EAAE,CAAC;gBACd,MAAM,KAAK,GAAG,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,CAAA;gBACjE,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC,EAAE,KAAK,EAAE,IAAI,CAAC,KAAK,EAAE,IAAI,CAAC,MAAM,EAAE,IAAI,CAAC,IAAI,CAAC,CAAA;aACpF;iBAAM;gBACL,IAAI,CAAC,MAAM,GAAG,CAAC,CAAC;aACjB;SACF;QACD,IAAI,CAAC,WAAW;YAAE,IAAI,CAAC,OAAO,EAAE,CAAC;QACjC,OAAO,IAAI,CAAC,MAAM,CAAC;KACpB;IAEO,eAAe,CAAC,uBAAiD,EAAE;QACzE,IAAI,CAAC,IAAI,GAAG,oBAAoB,CAAC;QACjC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,GAAG;YACnB,IAAI,GAAG,CAAC,MAAM;gBAAE,IAAI,CAAC,MAAM,IAAI,GAAG,CAAC,MAAM,CAAA;SAC1C,CAAC,CAAA;KACH;IAEO,uBAAuB,CAAC,QAAgB,CAAC,EAAE,cAAqB;QACtE,MAAM,OAAO,GAAG,IAAI,CAAC,QAAQ,CAAC,YAAY,CAAC,OAAO,CAAC;QACnD,IAAI,aAAgC,CAAC;QACrC,IAAI,gBAAgB,GAAG,MAAM,CAAC,SAAS,CAAC;QACxC,KAAK,MAAM,CAAC,IAAI,OAAO,CAAC,WAAW,EAAE,EAAE;YACrC,IAAI,CAAC,KAAK,cAAc;gBAAE,SAAS;YACnC,IAAI,CAAC,KAAK,IAAI,CAAC,cAAc,EAAE;gBAC7B,SAAS;aACV;YACD,MAAM,CAAC,GAAG,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC;YACjE,IAAI,CAAC,GAAG,KAAK,GAAC,KAAK,IAAI,CAAC,GAAG,gBAAgB,EAAE;gBAC3C,gBAAgB,GAAG,CAAC,CAAC;gBACrB,aAAa,GAAG,CAAC,CAAC;aACnB;SACF;QACD,OAAO,aAAa,CAAC;KACtB;;;;;"}