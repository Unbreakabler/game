{"version":3,"file":"projectile_handler.js","sources":["../../../../../../../src/scenes/entities/towers/components/projectile_handler.ts"],"sourcesContent":["import { gameModel, GameModel } from \"../../../../gamelogic/gamemodel\";\nimport type { TowerInfo } from \"../../../../gamelogic/td/tower_defense\";\nimport type TD from \"../../../td\"\nimport type Enemy from \"../../enemies/enemy\";\nimport type Tower from \"../tower\"\nimport Projectile from \"./projectile\";\n\n\n// Should this be passed down from td.ts instead?\nlet gameModelInstance: GameModel;\ngameModel.subscribe((m) => (gameModelInstance = m));\n\nfunction damageEnemy(enemy: Enemy, bullet: Projectile): void {\n  if (enemy.active && bullet.active && bullet.last_enemy_hit !== enemy && enemy.targettable) {\n    const bullet_damage = bullet.hit(enemy);\n    if (!bullet_damage) return;\n\n    bullet.last_enemy_hit = enemy;\n\n    const still_alive = enemy.receiveDamage(bullet_damage);\n    if (!still_alive) {\n      gameModelInstance.tower_defense.recordTowerKill(bullet.tower_id, enemy.name)\n    }\n    gameModelInstance.tower_defense.recordTowerDamage(bullet.tower_id, bullet_damage)\n  }\n}\n\nexport default (tower_info: TowerInfo) => {\n  return {\n    type: 'projectile_handler',\n    onInit: (parent: Tower, td_scene: TD, x: number, y:number) => {\n      parent.projectiles = td_scene.physics.add.group({\n        classType: Projectile,\n        frameQuantity: 100,\n        active: false,\n        visible: false, \n        key: parent.tower_info.status.projectile_type,\n        setXY: { x: -100, y: -100 },\n        runChildUpdate: false,\n      })\n\n      td_scene.physics.add.overlap(td_scene.wave_manager.enemies, parent.projectiles, damageEnemy as ArcadePhysicsCallback);\n      \n    },\n    onUpdate: (parent: Tower, time: number, delta: number) => {\n      parent.time_elapsed += delta;\n      if (parent.time_elapsed > parent.time_to_fire_next_shot) {\n        if (parent.target) {\n          const b: Projectile = parent.projectiles?.get(parent.x, parent.y, parent.tower_info.status.projectile_type, parent.tower_info.status.projectile_type);\n          // Extra properties read back from bullet\n          b.fire(parent, parent.tower_info.status.projectile_type);\n          parent.time_to_fire_next_shot = parent.time_elapsed + parent.tower_info.attributes.attack_speed;\n        }\n      }\n      if (parent.projectiles) {\n        for (const proj of parent.projectiles.getMatching('active', true)) {\n          proj.update(time, delta)\n        }\n      }\n    },\n  }\n}"],"names":[],"mappings":";;;AAQA;AACA,IAAI,iBAA4B,CAAC;AACjC,SAAS,CAAC,SAAS,CAAC,CAAC,CAAC,MAAM,iBAAiB,GAAG,CAAC,CAAC,CAAC,CAAC;AAEpD,SAAS,WAAW,CAAC,KAAY,EAAE,MAAkB;IACnD,IAAI,KAAK,CAAC,MAAM,IAAI,MAAM,CAAC,MAAM,IAAI,MAAM,CAAC,cAAc,KAAK,KAAK,IAAI,KAAK,CAAC,WAAW,EAAE;QACzF,MAAM,aAAa,GAAG,MAAM,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;QACxC,IAAI,CAAC,aAAa;YAAE,OAAO;QAE3B,MAAM,CAAC,cAAc,GAAG,KAAK,CAAC;QAE9B,MAAM,WAAW,GAAG,KAAK,CAAC,aAAa,CAAC,aAAa,CAAC,CAAC;QACvD,IAAI,CAAC,WAAW,EAAE;YAChB,iBAAiB,CAAC,aAAa,CAAC,eAAe,CAAC,MAAM,CAAC,QAAQ,EAAE,KAAK,CAAC,IAAI,CAAC,CAAA;SAC7E;QACD,iBAAiB,CAAC,aAAa,CAAC,iBAAiB,CAAC,MAAM,CAAC,QAAQ,EAAE,aAAa,CAAC,CAAA;KAClF;AACH,CAAC;AAED,yBAAe,CAAC,UAAqB;IACnC,OAAO;QACL,IAAI,EAAE,oBAAoB;QAC1B,MAAM,EAAE,CAAC,MAAa,EAAE,QAAY,EAAE,CAAS,EAAE,CAAQ;YACvD,MAAM,CAAC,WAAW,GAAG,QAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC;gBAC9C,SAAS,EAAE,UAAU;gBACrB,aAAa,EAAE,GAAG;gBAClB,MAAM,EAAE,KAAK;gBACb,OAAO,EAAE,KAAK;gBACd,GAAG,EAAE,MAAM,CAAC,UAAU,CAAC,MAAM,CAAC,eAAe;gBAC7C,KAAK,EAAE,EAAE,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,EAAE,CAAC,GAAG,EAAE;gBAC3B,cAAc,EAAE,KAAK;aACtB,CAAC,CAAA;YAEF,QAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,QAAQ,CAAC,YAAY,CAAC,OAAO,EAAE,MAAM,CAAC,WAAW,EAAE,WAAoC,CAAC,CAAC;SAEvH;QACD,QAAQ,EAAE,CAAC,MAAa,EAAE,IAAY,EAAE,KAAa;YACnD,MAAM,CAAC,YAAY,IAAI,KAAK,CAAC;YAC7B,IAAI,MAAM,CAAC,YAAY,GAAG,MAAM,CAAC,sBAAsB,EAAE;gBACvD,IAAI,MAAM,CAAC,MAAM,EAAE;oBACjB,MAAM,CAAC,GAAe,MAAM,CAAC,WAAW,EAAE,GAAG,CAAC,MAAM,CAAC,CAAC,EAAE,MAAM,CAAC,CAAC,EAAE,MAAM,CAAC,UAAU,CAAC,MAAM,CAAC,eAAe,EAAE,MAAM,CAAC,UAAU,CAAC,MAAM,CAAC,eAAe,CAAC,CAAC;;oBAEtJ,CAAC,CAAC,IAAI,CAAC,MAAM,EAAE,MAAM,CAAC,UAAU,CAAC,MAAM,CAAC,eAAe,CAAC,CAAC;oBACzD,MAAM,CAAC,sBAAsB,GAAG,MAAM,CAAC,YAAY,GAAG,MAAM,CAAC,UAAU,CAAC,UAAU,CAAC,YAAY,CAAC;iBACjG;aACF;YACD,IAAI,MAAM,CAAC,WAAW,EAAE;gBACtB,KAAK,MAAM,IAAI,IAAI,MAAM,CAAC,WAAW,CAAC,WAAW,CAAC,QAAQ,EAAE,IAAI,CAAC,EAAE;oBACjE,IAAI,CAAC,MAAM,CAAC,IAAI,EAAE,KAAK,CAAC,CAAA;iBACzB;aACF;SACF;KACF,CAAA;AACH,CAAC;;;;"}