{"version":3,"file":"tower.js","sources":["../../../../../src/scenes/entities/tower.ts"],"sourcesContent":["import Bullet from './tower_bullet';\n\nexport default class Turret extends Phaser.GameObjects.Image {\n  private next_tick = 0;\n  private projectiles: Phaser.GameObjects.Group | null = null;\n  private range = 150;\n  private attack_speed = 1000;\n  private damage = 50;\n\n  constructor(scene: Phaser.Scene) {\n    super(scene, 0, 0, 'turret');\n    // this.projectiles = this.scene.add.group({ classType: Bullet, runChildUpdate: true });\n  }\n\n  public place (place_y: number, place_x: number, height: number, width: number, turrets: Phaser.GameObjects.Group, path: Phaser.Curves.Path, bullets: Phaser.GameObjects.Group) {\n    this.projectiles = bullets\n    try {\n      // Get 50 random samples along the path, find the closest point to the tower.\n      // This will need to be scaled depending on the total length of the path.\n      const min_dist = path.getPoints(50).reduce((acc, point) => {\n        return Math.min(Phaser.Math.Distance.Between(place_x, place_y, point.x, point.y), acc);\n      }, 1000)\n      if (min_dist < 50) {\n        throw 'Can not place turret next to path'\n      }\n\n      turrets.children.entries.forEach((t) => {\n        let min_x = t.x - t.width/2\n        let max_x = t.x + t.width/2\n        let min_y = t.y - t.height/2\n        let max_y = t.y + t.height/2\n\n        let new_min_x = place_x - width/2\n        let new_max_x = place_x + width/2\n        let new_min_y = place_y - height/2\n        let new_max_y = place_y + height/2\n\n        const x_overlap = Math.max(0, Math.min(max_x, new_max_x) - Math.max(min_x, new_min_x));\n        const y_overlap = Math.max(0, Math.min(max_y, new_max_y) - Math.max(min_y, new_min_y));\n\n        if (x_overlap * y_overlap > 0) {\n          throw 'Can not place a turret over another another turret'\n        }\n      })\n      this.y = place_y;\n      this.x = place_x;\n      this.setActive(true);\n      this.setVisible(true);\n    } catch (e) {\n      console.error(`Error placing turret @ x:${place_x}, y:${place_y}`, e)\n      this.setActive(false);\n      this.setVisible(false);\n    }\n  }\n\n  public update (time: number, delta: number) {\n    // time to shoot\n    if (time > this.next_tick) {    \n      this.fire();\n      this.next_tick = time + this.attack_speed;\n    }\n  }\n\n  public fire() {\n    const enemy = this.scene.getEnemy(this.x, this.y, this.range);\n    if (enemy) {\n        const angle = Phaser.Math.Angle.Between(this.x, this.y, enemy.x, enemy.y);\n        this.addBullet(this.x, this.y, angle);\n        this.angle = (angle + Math.PI/2) * Phaser.Math.RAD_TO_DEG;\n    }\n  }\n\n  public addBullet(x: number, y: number, angle: number) {\n    if (this.projectiles) {\n      const bullet = this.projectiles.get();\n      if (bullet) {\n          bullet.fire(x, y, angle, this.range, this.damage);\n      }\n    }\n  }\n}"],"names":[],"mappings":"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"}